<div class="create-alert-container">
  <!-- Header -->
  <div class="header">
    <h2 class="title">Create Alert</h2>
    <div class="header-actions">
      <button class="btn btn-clear" (click)="cancel()">Cancel</button>
      <button class="btn btn-save" (click)="createAlert()">
        <span class="btn-icon">+</span>
        Create
      </button>
    </div>
  </div>

  <!-- Content Area -->
  <div class="content-wrapper">
    <!-- Redesigned Sidebar -->
    <div class="sidebar" #sidebar>
      <!-- Step connectors will be handled by CSS -->
      <div class="step-item" 
           [class.active]="activeSection === 'alert-details'" 
           [class.completed]="isStepCompleted(1)"
           (click)="scrollToSection('alert-details')">
        <div class="step-circle">
          <i class="bi bi-file-text step-icon" *ngIf="!isStepCompleted(1)"></i>
          <i class="bi bi-check-circle-fill step-icon" *ngIf="isStepCompleted(1)"></i>
        </div>
        <div class="step-info">
          <div class="step-number">Step 1/3</div>
          <div class="step-title" [class.completed-title]="isStepCompleted(1)">
            <span *ngIf="!isStepCompleted(1)" class="custom-dot"></span>
            <i *ngIf="isStepCompleted(1)" class="bi bi-check-circle-fill step-status-icon"></i>
            Alert Details
          </div>
        </div>
      </div>

      <div class="step-connector" [class.completed]="isStepCompleted(1)"></div>

      <div class="step-item" 
           [class.active]="activeSection === 'assign-members'" 
           [class.completed]="isStepCompleted(2)"
           [class.disabled]="!isStepCompleted(1)"
           (click)="scrollToSection('assign-members')">
        <div class="step-circle">
          <i class="bi bi-people step-icon" *ngIf="!isStepCompleted(2)"></i>
          <i class="bi bi-check-circle-fill step-icon" *ngIf="isStepCompleted(2)"></i>
        </div>
        <div class="step-info">
          <div class="step-number">Step 2/3</div>
          <div class="step-title" [class.completed-title]="isStepCompleted(2)">
            <span *ngIf="!isStepCompleted(2)" class="custom-dot"></span>
            <i *ngIf="isStepCompleted(2)" class="bi bi-check-circle-fill step-status-icon"></i>
            Assign Members
          </div>
        </div>
      </div>

      <div class="step-connector" [class.completed]="isStepCompleted(2)"></div>

      <div class="step-item" 
           [class.active]="activeSection === 'questionnaire'" 
           [class.completed]="isStepCompleted(3)"
           [class.disabled]="!isStepCompleted(2)"
           (click)="scrollToSection('questionnaire')">
        <div class="step-circle">
          <i class="bi bi-journals step-icon" *ngIf="!isStepCompleted(3)"></i>
          <i class="bi bi-check-circle-fill step-icon" *ngIf="isStepCompleted(3)"></i>
        </div>
        <div class="step-info">
          <div class="step-number">Step 3/3</div>
          <div class="step-title" [class.completed-title]="isStepCompleted(3)">
            <span *ngIf="!isStepCompleted(3)" class="custom-dot"></span>
            <i *ngIf="isStepCompleted(3)" class="bi bi-check-circle-fill step-status-icon"></i>
            Add Questionnaire
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" #mainContent (scroll)="onScroll()">
      <div class="scrollable-sections">
        
        <!-- Section 1: Alert Details -->
        <div class="section" id="alert-details" #alertDetailsSection>
          <div class="section-header">
            <h3 class="section-title">Alert Details</h3>
            <div class="section-number">1/3</div>
          </div>
          
          <!-- Transactions Table -->
          <div class="transactions-header">
            <span class="transactions-count">6 Transactions Selected</span>
          </div>
          
          <div class="transactions-table">
            <div class="table-header">
              <div class="table-cell">System Invoice</div>
              <div class="table-cell">Vendor Name</div>
              <div class="table-cell">Invoice Type</div>
              <div class="table-cell">Invoice Date</div>
            </div>
            <div class="table-row" *ngFor="let transaction of selectedTransactions">
              <div class="table-cell">{{transaction.systemInvoice}}</div>
              <div class="table-cell">{{transaction.vendorName}}</div>
              <div class="table-cell">{{transaction.invoiceType}}</div>
              <div class="table-cell">{{transaction.invoiceDate}}</div>
            </div>
          </div>

          <p class="info-text">
            These fields define the core information of your alert. Please review and complete them to ensure accurate content for the investigation.
          </p>

          <!-- Alert Configuration -->
          <div class="form-section">
            <div class="form-group">
              <label class="form-label">Alert Type*</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" id="transactions" [(ngModel)]="alertType" value="transactions" name="alertType" (change)="onFormFieldChange()">
                  <label for="transactions">Transactions</label>
                  <span class="radio-description">One per transaction</span>
                </div>
                <div class="radio-item">
                  <input type="radio" id="multi-transactions" [(ngModel)]="alertType" value="multi-transactions" name="alertType" (change)="onFormFieldChange()">
                  <label for="multi-transactions">Multi-transactions</label>
                  <span class="radio-description">One for all selected</span>
                </div>
                <div class="radio-item">
                  <input type="radio" id="entity" [(ngModel)]="alertType" value="entity" name="alertType" (change)="onFormFieldChange()">
                  <label for="entity">Entity</label>
                  <span class="radio-description">Based on involved entities</span>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Start Date*</label>
                <input type="date" [(ngModel)]="startDate" class="form-input" placeholder="dd/mm/yyyy" (change)="onFormFieldChange()">
              </div>
              <div class="form-group">
                <label class="form-label">End Date*</label>
                <input type="date" [(ngModel)]="endDate" class="form-input" placeholder="dd/mm/yyyy" (change)="onFormFieldChange()">
              </div>
              <div class="form-group">
                <label class="form-label">Select Priority*</label>
                <select [(ngModel)]="selectPriority" class="form-select" (change)="onFormFieldChange()">
                  <option value="">Select Priority</option>
                  <option value="Low">Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Alert ID</label>
                <input type="text" [(ngModel)]="alertId" class="form-input" readonly>
              </div>
              <div class="form-group">
                <label class="form-label">Risk Score</label>
                <input type="text" [value]="riskScore" class="form-input" readonly>
              </div>
              <div class="form-group">
                <label class="form-label">Risk Amount</label>
                <input type="text" [value]="riskAmount" class="form-input" readonly>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Comments</label>
              <textarea [(ngModel)]="comments" class="form-textarea" placeholder="Share your thoughts or findings" (change)="onFormFieldChange()"></textarea>
            </div>
          </div>
        </div>

        <!-- Section 2: Assign Members -->
        <div class="section" id="assign-members" #assignMembersSection>
          <div class="section-header">
            <h3 class="section-title">Assign Members</h3>
            <div class="section-number">2/3</div>
          </div>
          
          <p class="step-description">
            Assign the appropriate auditors or investigators to this alert. Project team assignment ensures efficient review and resolution.
          </p>

          <!-- Patterns Detected -->
          <div class="patterns-section" *ngIf="patternsDetected">
            <div class="patterns-header">
              <strong>Patterns Detected</strong>
              <button class="btn btn-save">+ IconAI</button>
            </div>
            <p class="patterns-text">
              Overlap detected with an existing alert under review.<br>
              <strong>Recommended assignment: {{recommendedAssignment}}</strong>
            </p>
          </div>

          <!-- Add Auditors -->
          <div class="auditors-section">
            <h3 class="section-title">Add Auditors</h3>

            <!-- L1 Auditor -->
            <div class="auditor-row">
              <div class="auditor-checkbox">
                <input type="checkbox" id="l1-auditor" [(ngModel)]="l1AuditorEnabled" (change)="toggleL1Auditor()">
                <label for="l1-auditor" class="auditor-label">L1 Auditor</label>
              </div>
              <div class="auditor-input">
                <button class="assign-button" [disabled]="!l1AuditorEnabled">Assign L1 auditors</button>
              </div>
            </div>

            <!-- L2 Auditor -->
            <div class="auditor-row">
              <div class="auditor-checkbox">
                <input type="checkbox" id="l2-auditor" [(ngModel)]="l2AuditorEnabled" (change)="toggleL2Auditor()">
                <label for="l2-auditor" class="auditor-label">L2 Auditor</label>
              </div>
              <div class="auditor-input">
                <div class="selected-auditor" *ngIf="l2AuditorEnabled && l2Auditor">
                  <span class="auditor-tag">{{l2Auditor}} <i class="remove-icon">×</i></span>
                </div>
                <button class="assign-button" [disabled]="!l2AuditorEnabled" *ngIf="!l2Auditor">Assign L2 auditors</button>
              </div>
            </div>

            <!-- L3 Auditor -->
            <div class="auditor-row">
              <div class="auditor-checkbox">
                <input type="checkbox" id="l3-auditor" [(ngModel)]="l3AuditorEnabled" (change)="toggleL3Auditor()">
                <label for="l3-auditor" class="auditor-label">L3 Auditor</label>
              </div>
              <div class="auditor-input">
                <div class="l3-auditor-container" *ngIf="l3AuditorEnabled">
                  <div class="selected-auditors">
                    <span class="auditor-tag" *ngFor="let auditor of l3Auditor">
                      {{auditor}} <i class="remove-icon" (click)="removeL3Auditor(auditor)">×</i>
                    </span>
                  </div>
                  <div class="search-container">
                    <input 
                      type="text" 
                      [(ngModel)]="searchTerm" 
                      (input)="onSearchChange()"
                      class="search-input" 
                      placeholder="Sara"
                      (focus)="showDropdown = true"
                    >
                    <div class="dropdown" *ngIf="showDropdown && searchTerm">
                      <div 
                        class="dropdown-item" 
                        *ngFor="let auditor of getFilteredAuditors()"
                        (click)="addL3Auditor(auditor.name)"
                      >
                        {{auditor.name}}
                      </div>
                    </div>
                  </div>
                </div>
                <button class="assign-button" [disabled]="!l3AuditorEnabled" *ngIf="l3AuditorEnabled && l3Auditor.length === 0">
                  Assign L3 auditors
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Add Questionnaire -->
        <div class="section" id="questionnaire" #questionnaireSection>
          <div class="section-header">
            <h3 class="section-title">Add Questionnaire</h3>
            <div class="section-number">3/3</div>
          </div>
          
          <p class="step-description">
            Select or create a questionnaire to guide the audit process. This helps maintain consistency and thoroughness in investigations.
          </p>

          <div class="questionnaire-section">
            <div class="questionnaires-list">
              <h3 class="section-title">Questionnaires</h3>
              <div class="questionnaire-item" *ngFor="let questionnaire of questionnaires">
                <span class="questionnaire-name">{{questionnaire.name}}</span>
                <div class="questionnaire-actions">
                  <i class="icon-visibility">👁</i>
                  <i class="icon-menu">⋮</i>
                </div>
              </div>
            </div>

            <div class="questionnaire-assignments">
              <!-- L1 Auditor Questionnaire -->
              <div class="questionnaire-assignment">
                <h4 class="assignment-title">L1 Auditor Questionnaire</h4>
                <div class="file-drop-area">
                  <p>Drag and drop questionnaire here</p>
                  <p class="file-limit">Limit: 1</p>
                  <input type="file" (change)="onFileSelected($event, 'l1')" style="display: none;" #l1FileInput>
                  <button class="btn btn-secondary" (click)="l1FileInput.click()">Browse Files</button>
                </div>
              </div>

              <!-- L2 Auditor Questionnaire -->
              <div class="questionnaire-assignment">
                <h4 class="assignment-title">L2 Auditor Questionnaire</h4>
                <div class="file-drop-area">
                  <p>Drag and drop questionnaire here</p>
                  <p class="file-limit">Limit: 1</p>
                  <input type="file" (change)="onFileSelected($event, 'l2')" style="display: none;" #l2FileInput>
                  <button class="btn btn-secondary" (click)="l2FileInput.click()">Browse Files</button>
                </div>
              </div>

              <!-- L3 Auditor Questionnaire -->
              <div class="questionnaire-assignment">
                <h4 class="assignment-title">L3 Auditor Questionnaire</h4>
                <div class="file-drop-area">
                  <p>Drag and drop questionnaire here</p>
                  <p class="file-limit">Limit: 1</p>
                  <input type="file" (change)="onFileSelected($event, 'l3')" style="display: none;" #l3FileInput>
                  <button class="btn btn-secondary" (click)="l3FileInput.click()">Browse Files</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
</div>